import 'dart:io';
import 'dart:typed_data';
import 'package:flutter/services.dart' show rootBundle;
import 'package:path_provider/path_provider.dart';
import 'package:sqlite3/sqlite3.dart' as sqlite;

class MbTilesDb {
  final sqlite.Database _db;
  MbTilesDb._(this._db);

  static Future<MbTilesDb> openFromAsset(
    String assetPath, {
    String? logicalName,
  }) async {
    final dir = await getApplicationDocumentsDirectory();
    final fileName = logicalName ?? assetPath.split('/').last;
    final dest = File('${dir.path}/$fileName');
    if (!await dest.exists()) {
      final bytes = await rootBundle.load(assetPath);
      await dest.writeAsBytes(bytes.buffer.asUint8List());
    }
    final db = sqlite.sqlite3.open(dest.path, mode: sqlite.OpenMode.readOnly);
    return MbTilesDb._(db);
  }

  Uint8List? getTileBytes({
    required int z,
    required int x,
    required int yIsXyz,
  }) {
    final tmsY = _xyzToTmsY(z, yIsXyz);
    final stmt = _db.prepare(
      'SELECT tile_data FROM tiles WHERE zoom_level = ? AND tile_column = ? AND tile_row = ? LIMIT 1',
    );
    try {
      final result = stmt.select([z, x, tmsY]);
      if (result.isEmpty) return null;
      final data = result.first['tile_data'];
      if (data is Uint8List) return data;
      if (data is List<int>) return Uint8List.fromList(data);
      return null;
    } finally {
      stmt.dispose();
    }
  }

  void close() => _db.dispose();

  int _xyzToTmsY(int z, int y) => (1 << z) - 1 - y;
}
